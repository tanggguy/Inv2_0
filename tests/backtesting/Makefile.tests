# Makefile pour les tests du module backtesting

.PHONY: help test test-all test-engine test-analyzer test-coverage test-quick test-verbose clean

# Couleurs
BLUE := \033[0;34m
GREEN := \033[0;32m
NC := \033[0m # No Color

help: ## Afficher cette aide
	@echo "$(BLUE)Commandes disponibles:$(NC)"
	@grep -E '^[a-zA-Z_-]+:.*?## .*$$' $(MAKEFILE_LIST) | sort | awk 'BEGIN {FS = ":.*?## "}; {printf "  $(GREEN)%-20s$(NC) %s\n", $$1, $$2}'

install-test-deps: ## Installer les dÃ©pendances de test
	pip install -r requirements-test.txt

test: test-all ## ExÃ©cuter tous les tests (alias)

test-all: ## ExÃ©cuter tous les tests
	@echo "$(BLUE)ğŸ§ª ExÃ©cution de tous les tests...$(NC)"
	pytest tests/backtesting/ -v

test-engine: ## Tester BacktestEngine uniquement
	@echo "$(BLUE)ğŸ§ª Test de BacktestEngine...$(NC)"
	pytest tests/backtesting/test_backtest_engine.py -v

test-analyzer: ## Tester PerformanceAnalyzer uniquement
	@echo "$(BLUE)ğŸ§ª Test de PerformanceAnalyzer...$(NC)"
	pytest tests/backtesting/test_performance_analyzer.py -v

test-coverage: ## ExÃ©cuter les tests avec couverture de code
	@echo "$(BLUE)ğŸ§ª Tests avec couverture...$(NC)"
	pytest tests/backtesting/ --cov=backtesting --cov-report=html --cov-report=term-missing
	@echo "$(GREEN)âœ… Rapport disponible: htmlcov/index.html$(NC)"

test-quick: ## Tests rapides sans dÃ©tails
	@echo "$(BLUE)âš¡ Tests rapides...$(NC)"
	pytest tests/backtesting/ -q --tb=line

test-verbose: ## Tests en mode verbeux
	@echo "$(BLUE)ğŸ” Tests verbeux...$(NC)"
	pytest tests/backtesting/ -vv -s

test-parallel: ## ExÃ©cuter les tests en parallÃ¨le
	@echo "$(BLUE)âš¡ Tests en parallÃ¨le...$(NC)"
	pytest tests/backtesting/ -n auto

test-failed: ## RÃ©-exÃ©cuter seulement les tests Ã©chouÃ©s
	@echo "$(BLUE)ğŸ”„ RÃ©-exÃ©cution des tests Ã©chouÃ©s...$(NC)"
	pytest tests/backtesting/ --lf -v

test-debug: ## ExÃ©cuter les tests en mode debug
	@echo "$(BLUE)ğŸ› Mode debug...$(NC)"
	pytest tests/backtesting/ --pdb -x

test-watch: ## Mode watch (rÃ©-exÃ©cution automatique)
	@echo "$(BLUE)ğŸ‘€ Mode watch...$(NC)"
	pytest-watch tests/backtesting/

clean: ## Nettoyer les fichiers temporaires
	@echo "$(BLUE)ğŸ§¹ Nettoyage...$(NC)"
	find . -type d -name "__pycache__" -exec rm -rf {} + 2>/dev/null || true
	find . -type d -name ".pytest_cache" -exec rm -rf {} + 2>/dev/null || true
	find . -type d -name "htmlcov" -exec rm -rf {} + 2>/dev/null || true
	find . -type f -name ".coverage" -delete 2>/dev/null || true
	find . -type f -name "*.pyc" -delete 2>/dev/null || true
	@echo "$(GREEN)âœ… Nettoyage terminÃ©$(NC)"

show-coverage: ## Ouvrir le rapport de couverture dans le navigateur
	@if [ -f htmlcov/index.html ]; then \
		echo "$(BLUE)ğŸ“Š Ouverture du rapport...$(NC)"; \
		python -m webbrowser htmlcov/index.html; \
	else \
		echo "$(GREEN)GÃ©nÃ©rez d'abord le rapport avec: make test-coverage$(NC)"; \
	fi

lint-tests: ## VÃ©rifier le style du code des tests
	@echo "$(BLUE)ğŸ” VÃ©rification du style...$(NC)"
	pylint tests/backtesting/ --disable=C0111,R0903,R0913 || true

format-tests: ## Formater le code des tests
	@echo "$(BLUE)âœ¨ Formatage du code...$(NC)"
	black tests/backtesting/
	isort tests/backtesting/

check-tests: test-coverage lint-tests ## VÃ©rification complÃ¨te (tests + lint)
	@echo "$(GREEN)âœ… VÃ©rification complÃ¨te terminÃ©e$(NC)"